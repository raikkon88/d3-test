<!DOCTYPE html>
<html>

  <head>
    <script src="https://d3js.org/d3.v4.js" type="text/javascript"></script>
  </head>

  <body>

  <div id="container">
    <svg id="svg" width="300" height="300"></svg>
  </div>


  <script type="text/javascript">
  /**
   * D3 programming test to display tree structure.
   */

   var max_level = 0;
   var svg = d3.select("svg"),
   width = +svg.attr("width"),
   height = +svg.attr("height");
   var radius = 8;

   /**
    * Given a json tree as treeData and a d3.treemap()
    * Mounts all information inside json tree (treeData)
    * into d3.treemap() named tree
    */
   function parseJsonTree(treeData, nodes, links, level, brother_length, start, end){
     if(level > max_level) { max_level = level; }
     nodes.push({"name": treeData.name, "level": level, "xPos": (start + end) / 2});
     if(treeData.children.length > 0){
       var difference = ((end - start) / (treeData.children.length));
       var next_start = start;
       treeData.children.forEach(function(t){
        links.push({"source": treeData.name, "target":t.name });
        parseJsonTree(t, nodes, links, level+1, treeData.children.length, next_start, next_start + difference);
        next_start += difference;
       });
     }
   }

   /** Genera una estructura en forma d'arbre */
   let treeData = {
      "name":1,
      "children" : [
        {
          "name":11,
          "children":[]
        },
        {
          "name":12,
          "children":[
            {
              "name":121,
              "children":[]
            },
            {
              "name":122,
              "children":[]
            }
          ]
        },
        {
          "name":2,
          "children" : []
        }
      ]
    };


    console.log(treeData);
    /** Captura l'svg on s'imprimeix el resultat */
    //var svg = document.getElementById("svg");
    //console.log(svg);



    var nodes = [];
    var links = [];
    parseJsonTree(treeData, nodes, links, max_level + 1, treeData.children.length, 0, width);
    var level_distance = width / (max_level + 1);
    console.log(svg);
    console.log(links);

    var link_force = d3.forceLink(links).id(function(d){return d.name;})
                       .distance(level_distance);
    var charge_force = d3.forceManyBody().strength(-100);
    var center_force = d3.forceCenter(width / 2, height / 2);


    var simulation = d3.forceSimulation()
                       .nodes(nodes)
                       .force("center_force", center_force)
                       .force("charge_force", charge_force)
                       .force("link_force", link_force)
    //                   .force("forceX", charge_force)
                       .on("tick", tick);


    //draw lines for the links
    var link = svg.append("g")
                  .attr("class", "links")
                  .selectAll("line")
                  .data(links)
                  .enter().append("line")
                  .attr("stroke-width", 2)
                  .style("stroke", "blue");

    //draw circles for the nodes
    var node = svg.append("g")
                  .attr("class", "nodes")
                  .selectAll("circle")
                  .data(nodes)
                  .enter()
                  .append("circle")
                  .attr("r", radius)
                  .attr("fill", "red");


    var drag_handler = d3.drag()
      .on("start", drag_start)
      .on("drag", drag_drag)
      .on("end", drag_end);

    drag_handler(node);

    //drag handler
    //d is the node
    function drag_start(d) {
     if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function drag_drag(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }


    function drag_end(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    function tick() {
      var k = 6 * simulation.alpha();
      // Push sources up and targets down to form a weak tree.
      link
          .each(function(d) {
            d.source.y -= k, d.target.y += k;
          })//d.source.y -= k, d.target.y += k; })*/
          .attr("x1", function(d) { return d.source.xPos; })
          .attr("y1", function(d) { return d.source.level * level_distance; })
          .attr("x2", function(d) { return d.target.xPos; })
          .attr("y2", function(d) { return d.target.level * level_distance; });

      node
          .attr("cx", function(d) { return d.xPos; })
          .attr("cy", function(d) { return d.level * level_distance; });
      }

  </script>


  </body>
</html>
